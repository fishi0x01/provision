---
# https://kushaldas.in/posts/fixing-missing-yubikey-trouble-on-fedora-38.html
- name: Make sure opensc is removed
  ansible.builtin.dnf:
    name: opensc
    state: absent

- name: Put trusted keys into chain
  block:
  - name: Copy trusted key
    copy:
      src: files/{{ item.trusted_key_long_id }}.asc
      dest: /tmp/{{ item.trusted_key_long_id }}.asc
      owner: "{{ machine_user }}"
      group: "{{ machine_user }}"
      mode: '0644'
    loop: "{{ gpg.pub_keys }}"

  - name: Import trusted key
    become: yes
    become_user: "{{ machine_user }}"
    command: "gpg --import /tmp/{{ item.trusted_key_long_id }}.asc"
    loop: "{{ gpg.pub_keys }}"

- name: Ensure .ssh dir exists
  file:
    path: "/home/{{ machine_user }}/.ssh"
    state: directory
    owner: "{{ machine_user }}"
    group: "{{ machine_user }}"
    mode: '0755'

- name: Place ssh pub key
  copy:
    src: "files/{{ item.ssh_pub_file }}"
    dest: "{{ item.ssh_pub_dest }}"
    owner: "{{ machine_user }}"
    group: "{{ machine_user }}"
    mode: "644"
  loop: "{{ gpg.pub_keys }}"

- name: Set gpg-agent.conf
  become: yes
  become_user: "{{ machine_user }}"
  template:
    src: "templates/gpg-agent.conf.j2"
    dest: "{{ gpg.agent_conf_file }}"
    owner: "{{ machine_user }}"
    group: "{{ machine_user }}"
    mode: "640"
  notify:
    - "restart gpg-agent"

- name: Set gpg.conf
  become: yes
  become_user: "{{ machine_user }}"
  template:
    src: "templates/gpg.conf.j2"
    dest: "{{ gpg.conf_file }}"
    owner: "{{ machine_user }}"
    group: "{{ machine_user }}"
    mode: "640"
  notify:
    - "restart gpg-agent"

- name: Set scdaemon.conf
  become: yes
  become_user: "{{ machine_user }}"
  template:
    src: "templates/scdaemon.conf.j2"
    dest: "{{ gpg.scdaemon_conf_file }}"
    owner: "{{ machine_user }}"
    group: "{{ machine_user }}"
    mode: "640"
  notify:
    - "restart gpg-agent"

- meta: flush_handlers
