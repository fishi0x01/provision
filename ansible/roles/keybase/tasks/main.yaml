---
- name: "Check if keybase is installed"
  package_facts:
    manager: "auto"

- name: Install keybase
  block:
    # https://keybase.io/docs/server_security/our_code_signing_key
    - name: Copy keybase.asc
      copy:
        src: files/asc/keybase.asc
        dest: /tmp/keybase.asc
        owner: "{{ machine_user }}"
        group: "{{ machine_user }}"
        mode: '0644'

    - name: Import keybase.asc
      shell:
        "gpg --import /tmp/keybase.asc"

    - name: Download keybase.rpm
      get_url:
        url: "https://prerelease.keybase.io/keybase_amd64.rpm"
        dest: /tmp/keybase_amd64.rpm
        mode: '0640'

    - name: Install keybase.rpm
      ansible.builtin.dnf:
        name: /tmp/keybase_amd64.rpm
        state: present
  when: "'keybase' not in ansible_facts.packages"
